{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-7">
            <h3 class="mb-4 fw-bold">Datos de Env√≠o üì¶</h3>
            <form action="/finalizar" method="POST" id="form-compra">
                <div class="mb-3">
                    <label class="form-label">Nombre Completo</label>
                    <input type="text" name="nombre" class="form-control" required placeholder="Juan P√©rez">
                </div>
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" name="email" class="form-control" required placeholder="juan@ejemplo.com">
                </div>
                <div class="mb-3">
                    <label class="form-label">Tel√©fono / WhatsApp</label>
                    <input type="tel" name="telefono" class="form-control" required placeholder="11 1234 5678">
                </div>
                <div class="mb-3">
                    <label class="form-label">Direcci√≥n de Entrega</label>
                    <input type="text" name="direccion" class="form-control" required placeholder="Calle Falsa 123, Tigre">
                </div>

                <div class="mb-3">
                    <label class="form-label">C√≥digo Postal (Opcional)</label>
                    <input type="text" name="cp" id="cp-destino" class="form-control" placeholder="1425">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Seleccion√° tu Env√≠o</label>
                    <div id="envio-opciones" class="mt-2">
                        <div class="text-center py-3">
                            <div class="spinner-border text-secondary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="envio_tipo" id="envio_tipo">
                    <input type="hidden" name="envio_nombre" id="envio_nombre">
                    <input type="hidden" name="envio_precio" id="envio_precio" value="0">
                </div>

                <input type="hidden" name="carrito_data" id="carrito_input">

                <button type="submit" class="btn btn-fachero w-100 btn-lg mt-3" id="btn-confirmar" disabled>
                    CONFIRMAR PEDIDO
                </button>
            </form>
        </div>

        <div class="col-md-5">
            <div class="card bg-light border-0 shadow-sm p-3 mt-4 mt-md-0">
                <h4 class="fw-bold">Resumen</h4>
                <div id="resumen-items" class="small text-muted mb-3">
                    </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span class="fw-bold">Env√≠o</span>
                    <span class="fw-bold">$<span id="envio-resumen">0</span></span>
                </div>
                <h3 class="fw-bold text-end mt-2">Total: $<span id="total-resumen">0</span></h3>
            </div>
        </div>
    </div>
</div>

<script>
    // Apenas carga, copiamos el carrito del LocalStorage al Input Oculto
    document.addEventListener("DOMContentLoaded", function() {
        const carrito = localStorage.getItem('carrito') || '[]';
        
        // 1. Rellenar el input oculto para Python
        document.getElementById('carrito_input').value = carrito;

        // 2. Rellenar el resumen visual de la derecha
        const items = JSON.parse(carrito);
        let totalProductos = 0;
        let totalEnvio = 0;
        const resumenDiv = document.getElementById('resumen-items');
        
        if(items.length === 0) {
            alert("El carrito est√° vac√≠o, volv√© a elegir productos.");
            window.location.href = "/productos";
        }

        items.forEach(prod => {
            const subtotal = prod.precio * prod.cantidad;
            totalProductos += subtotal;
            resumenDiv.innerHTML += `
                <div class="d-flex justify-content-between">
                    <span>${prod.cantidad}x ${prod.nombre}</span>
                    <span>$${subtotal}</span>
                </div>
            `;
        });

        function renderTotales() {
            document.getElementById('envio-resumen').innerText = totalEnvio.toFixed(2);
            document.getElementById('total-resumen').innerText = (totalProductos + totalEnvio).toFixed(2);
            document.getElementById('envio_precio').value = totalEnvio;
        }

        renderTotales();

        // Cargar opciones de env√≠o desde nuestra API interna
        const opcionesDiv = document.getElementById('envio-opciones');
        const btnConfirmar = document.getElementById('btn-confirmar');

        async function cargarEnvios() {
            try {
                const res = await fetch('/api/envios');
                const envios = await res.json();
                
                opcionesDiv.innerHTML = "";
                
                if (envios.length === 0) {
                    opcionesDiv.innerHTML = '<div class="alert alert-warning">No hay m√©todos de env√≠o disponibles. Contactanos.</div>';
                    return;
                }

                envios.forEach(envio => {
                    const id = `envio-${envio.id}`;
                    opcionesDiv.innerHTML += `
                        <label class="w-100 border rounded p-3 mb-2 d-block" for="${id}" style="cursor:pointer;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">${envio.nombre}</div>
                                </div>
                                <div class="fw-bold">$${envio.precio.toFixed(2)}</div>
                            </div>
                            <input class="form-check-input mt-2" type="radio" name="envio_radio" id="${id}" 
                                   value="${envio.id}" data-nombre="${envio.nombre}" data-precio="${envio.precio}" required />
                        </label>
                    `;
                });

                // Escuchar cambios en los radio buttons
                const radios = document.getElementsByName('envio_radio');
                radios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const nombre = e.target.getAttribute('data-nombre');
                        const precio = parseFloat(e.target.getAttribute('data-precio'));
                        
                        document.getElementById('envio_tipo').value = 'Personalizado'; // Opcional
                        document.getElementById('envio_nombre').value = nombre;
                        totalEnvio = precio;
                        renderTotales();
                        btnConfirmar.disabled = false;
                    });
                });

            } catch (e) {
                console.error(e);
                opcionesDiv.innerHTML = '<div class="text-danger">Error cargando env√≠os. Recarg√° la p√°gina.</div>';
            }
        }

        cargarEnvios();
    });

    // Limpiar carrito al enviar (Opcional, si quer√©s que se vac√≠e al comprar)
    document.getElementById('form-compra').addEventListener('submit', function() {
        localStorage.removeItem('carrito');
    });
</script>
{% endblock %}
